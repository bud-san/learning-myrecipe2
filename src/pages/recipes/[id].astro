---
import BaseLayout from '../../layouts/BaseLayout.astro'
import Header from '../../components/Header.astro'
import IngredientsSection from '../../components/IngredientsSection.astro'
import StepsSection from '../../components/StepsSection.astro'
import type { Recipe } from '../../lib/microcms'
import { fetchAllRecipes } from '../../lib/microcms'

export async function getStaticPaths() {
  const recipes = await fetchAllRecipes()
  return recipes.map((recipe) => ({
    params: { id: recipe.id },
    props: { recipe },
  }))
}

const { recipe } = Astro.props as { recipe: Recipe }
---

<BaseLayout title={`${recipe.title} - RecipeHub`}>
  <Header />
  <main class="flex-1 w-full">
    <div class="max-w-[1200px] mx-auto px-4 md:px-10 py-8 flex flex-col gap-8">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 lg:gap-12 items-start">
        <div class="lg:col-span-3 flex flex-col gap-6 pt-2">
          <h1 class="text-4xl md:text-5xl font-extrabold text-[#181211] dark:text-white leading-[1.1] tracking-tight">
            {recipe.title}
          </h1>
          <div class="flex flex-wrap items-center gap-4 text-gray-600 dark:text-gray-300">
            <div class="flex items-center gap-1.5 bg-white dark:bg-white/5 px-3 py-1.5 rounded-lg shadow-sm border border-gray-100 dark:border-white/10">
              <span class="material-symbols-outlined text-primary text-[20px]">schedule</span>
              <span class="text-sm font-medium">
                更新 {new Intl.DateTimeFormat('ja-JP').format(new Date(recipe.updatedAt))}
              </span>
            </div>
          </div>
          {recipe.description && (
            <p class="text-gray-600 dark:text-gray-300 text-lg leading-relaxed whitespace-pre-wrap">
              {recipe.description}
            </p>
          )}
          {(recipe.cooking ?? []).length > 0 && (
            <div class="flex flex-wrap gap-2 pt-2">
              {(recipe.cooking ?? []).map((item) => (
                <span class="inline-flex items-center px-3 py-1 rounded-lg bg-gray-100 dark:bg-white/10 text-sm font-medium text-gray-600 dark:text-gray-300">
                  #{item}
                </span>
              ))}
            </div>
          )}
          {recipe.report && (
            <div class="rounded-2xl bg-white/70 dark:bg-[#2f1f1c] border border-[#e6dddb] dark:border-[#3e2d2a] p-4 space-y-2">
              <div class="flex items-center gap-2 text-[#181211] dark:text-white font-semibold">
                <span class="material-symbols-outlined">note_alt</span>
                <span>作ったメモ</span>
              </div>
              <p class="text-sm text-[#181211] dark:text-white leading-relaxed whitespace-pre-wrap">{recipe.report}</p>
            </div>
          )}
        </div>
        <div class="lg:col-span-2 relative group h-[300px] lg:h-[360px] w-full">
          <div class="absolute inset-0 bg-gradient-to-tr from-black/20 to-transparent rounded-[2rem] z-10 pointer-events-none"></div>
          <div class="w-full h-full rounded-[2rem] overflow-hidden shadow-2xl bg-gray-200 dark:bg-gray-800 relative group">
            <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 bg-gray-100 dark:bg-gray-800">
              <span class="material-symbols-outlined text-[64px] mb-2">image_not_supported</span>
              <span class="text-sm font-medium">No Image Available</span>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-10 mt-2">
        <div class="flex flex-col gap-6">
          <input checked class="hidden" id="tab-ingredients" name="recipe-tabs" type="radio" />
          <input class="hidden" id="tab-steps" name="recipe-tabs" type="radio" />
          <div class="sticky top-[72px] z-40 bg-background-light dark:bg-background-dark pt-2 pb-4 tab-controls">
            <div class="bg-white dark:bg-white/5 p-1.5 rounded-2xl shadow-sm border border-gray-100 dark:border-white/5 inline-flex w-full md:w-auto">
              <label
                class="flex-1 md:flex-none px-8 py-3 rounded-xl cursor-pointer font-bold text-sm md:text-base flex items-center justify-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-white/10 text-gray-600 dark:text-gray-300"
                for="tab-ingredients"
              >
                <span class="material-symbols-outlined">grocery</span>
                材料チェックリスト
              </label>
              <label
                class="flex-1 md:flex-none px-8 py-3 rounded-xl cursor-pointer font-bold text-sm md:text-base flex items-center justify-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-white/10 text-gray-600 dark:text-gray-300"
                for="tab-steps"
              >
                <span class="material-symbols-outlined">menu_book</span>
                作り方・手順
              </label>
            </div>
          </div>
          <div class="hidden tab-content-ingredients">
            <IngredientsSection ingredients={recipe.ingredients ?? []} servings={recipe.servings} />
          </div>
          <div class="hidden tab-content-steps">
            <StepsSection steps={recipe.steps ?? []} />
          </div>
        </div>
      </div>

      {recipe.ai && (
        <div class="grid grid-cols-1 gap-6 items-start">
          <div class="bg-white dark:bg-white/5 rounded-[2rem] p-6 shadow-sm border border-gray-100 dark:border-white/5">
            <h3 class="text-lg font-bold text-[#181211] dark:text-white mb-4">栄養成分 (1人分)</h3>
            <div class="mb-6 p-4 bg-green-50 dark:bg-green-900/10 rounded-xl border border-green-100 dark:border-green-900/30">
              <h4 class="flex items-center gap-2 text-sm font-bold text-green-800 dark:text-green-200 mb-2">
                <span class="material-symbols-outlined text-[18px]">health_and_safety</span>
                栄養素総評
              </h4>
              <p class="text-sm text-green-800/80 dark:text-green-200/80 leading-relaxed whitespace-pre-wrap">{recipe.ai}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  </main>
</BaseLayout>
